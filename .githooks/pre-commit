#!/bin/sh

# Auto-bump patch version if developer hasn't changed it manually.
# Compares package.json version against HEAD. If unchanged, bumps patch (e.g. 0.1.0 -> 0.1.1).

CURRENT_VERSION=$(node -p "require('./package.json').version")
HEAD_VERSION=$(git show HEAD:package.json 2>/dev/null | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin','utf8')).version" 2>/dev/null || echo "")

# Skip if no HEAD yet (first commit) or version already changed manually
if [ -z "$HEAD_VERSION" ] || [ "$CURRENT_VERSION" != "$HEAD_VERSION" ]; then
  exit 0
fi

# Bump patch version
NEW_VERSION=$(node -p "const [a,b,c]='${CURRENT_VERSION}'.split('.').map(Number); a+'.'+b+'.'+(c+1)")

node -e "
  const fs = require('fs');
  const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
  pkg.version = '${NEW_VERSION}';
  fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
"

git add package.json
echo "[auto-version] Bumped: ${CURRENT_VERSION} -> ${NEW_VERSION}"
